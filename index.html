async function fetchBalance() {
    if (!walletPublicKey) return;

    loadingDiv.style.display = 'block';
    balanceDiv.textContent = '';
    retryBtn.style.display = 'none';

    const rpcEndpoints = [
        'https://api.mainnet-beta.solana.com',
        'https://solana-mainnet.rpc.extrnode.com'
    ];
    const mintAddress = '8Eu56eBrzP3aFcmAz23fCGyHaZkqBqFdPhHojob5pump';

    try {
        new solanaWeb3.PublicKey(mintAddress);
    } catch (err) {
        console.error('Invalid mint address:', err);
        balanceDiv.textContent = 'Invalid token mint address. Please contact support at support@samsage.com.';
        retryBtn.style.display = 'block';
        loadingDiv.style.display = 'none';
        return;
    }

    const mintPublicKey = new solanaWeb3.PublicKey(mintAddress);

    for (const endpoint of rpcEndpoints) {
        try {
            console.log(`Attempting to fetch balance from ${endpoint}`);
            const connection = new solanaWeb3.Connection(endpoint, 'confirmed');
            const slot = await connection.getSlot();
            console.log(`Connected to RPC at slot ${slot}`);

            const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                new solanaWeb3.PublicKey(walletPublicKey),
                { mint: mintPublicKey }
            );

            let totalBalance = 0;
            if (tokenAccounts.value.length === 0) {
                balanceDiv.textContent = 'No $SAMSAGE tokens found in this wallet.';
                balanceDiv.style.color = '#cccccc';
            } else {
                for (const account of tokenAccounts.value) {
                    const info = account.account.data.parsed.info;
                    totalBalance += Number(info.tokenAmount.uiAmountString || 0);
                }
                balanceDiv.textContent = `${totalBalance.toLocaleString()} $SAMSAGE`;
                balanceDiv.style.color = totalBalance > 0 ? '#FFD700' : '#cccccc';
            }
            loadingDiv.style.display = 'none';
            return;
        } catch (err) {
            console.error(`Error fetching balance from ${endpoint}:`, err);
            let errorMessage = 'Failed to load balance. Please try again.';
            if (err.message.includes('429')) {
                errorMessage = 'Rate limit exceeded. Please try again later.';
            } else if (err.message.includes('network') || err.message.includes('Failed to fetch')) {
                errorMessage = 'Unable to connect to Solana network. Ensure Phantom is set to Mainnet Beta and check your internet.';
            } else if (err.message.includes('Invalid public key')) {
                errorMessage = 'Invalid token mint address. Please contact support at support@samsage.com.';
            }
            balanceDiv.textContent = errorMessage;
        }
    }

    balanceDiv.textContent = 'Failed to connect to Solana network. Please ensure Phantom is set to Mainnet Beta and try again or contact support@samsage.com.';
    retryBtn.style.display = 'block';
    loadingDiv.style.display = 'none';
}
